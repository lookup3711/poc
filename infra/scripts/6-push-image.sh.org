#!/bin/bash
set -euo pipefail

# === å¼•æ•°å‡¦ç† ===
ENV="${1:-xxx}"  # å¼•æ•°ãŒãªã‘ã‚Œã° "xxx" ã‚’ãƒ€ãƒŸãƒ¼ã¨ã—ã¦ä½¿ç”¨
if [[ "$ENV" != "dev" && "$ENV" != "prd" ]]; then
  echo "âŒ ä½¿ç”¨æ–¹æ³•: $0 [dev|prd]"
  exit 1
fi

# === è¨­å®š ===
source ./env/${ENV}.env
IMAGE_TAG="${2:-cloudformation}"
echo $IMAGE_TAG

REPO_URI=$(aws cloudformation describe-stacks \
  --stack-name ${ENV}-${PROJECT}-ecr \
  --query "Stacks[0].Outputs[?OutputKey=='ECRRepositoryUri'].OutputValue" \
  --output text --region "$REGION")

echo "ğŸ” ECR ã«ãƒ­ã‚°ã‚¤ãƒ³..."
aws ecr get-login-password --region $REGION \
  | docker login --username AWS --password-stdin ${REPO_URI%%/*}

echo "ğŸš€ Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
cd ../backend
docker buildx build --platform linux/amd64 \
  -f Dockerfile-gitops \
  -t ${REPO_URI}:${IMAGE_TAG} \
  --push .

echo "âœ… ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ—ãƒƒã‚·ãƒ¥å®Œäº†"
